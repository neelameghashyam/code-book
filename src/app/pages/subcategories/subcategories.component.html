<div class="container">
  <div *ngIf="subcategoriesService.error()" class="error-message mb-16 p-16 rounded-8">
    Error: {{ subcategoriesService.error() }}
  </div>

  <mat-card class="mb-16">
    <div class="flex justify-between items-center">
      <mat-form-field appearance="outline" class="w-1/3">
        <mat-label>Select Category</mat-label>
        <mat-select [value]="selectedCategoryId" (selectionChange)="onCategoryChange($event.value)" aria-label="Select category">
          <mat-option [value]="null">All Categories</mat-option>
          <mat-option *ngFor="let category of categories" [value]="category.id">
            {{ category.name }}
          </mat-option>
        </mat-select>
      </mat-form-field>

      <div class="flex items-center gap-8">
        <mat-form-field appearance="outline" class="w-64">
          <mat-label>Search Subcategories</mat-label>
          <input matInput id="searchSubcategories" (input)="onSearchQueryChange($event)" aria-label="Search subcategories">
        </mat-form-field>
        <button mat-icon-button (click)="refreshTable()" aria-label="Refresh table">
          <mat-icon>refresh</mat-icon>
        </button>
        <button mat-raised-button color="primary" (click)="openAddSubcategoryDialog()" aria-label="Add new subcategory">
          Add Subcategory
        </button>
        <button mat-raised-button color="warn" [disabled]="selectedSubcategories.length === 0" (click)="deleteSelectedSubcategories()" aria-label="Delete selected subcategories">
          Delete Selected
        </button>
      </div>
    </div>
  </mat-card>

  <div class="table-container" [ngClass]="{'dark-theme': darkModeService.isDarkMode()}">
    <mat-spinner *ngIf="subcategoriesService.isLoading()" diameter="50"></mat-spinner>
    <table mat-table [dataSource]="subcategoriesService.paginatedSubcategories()" *ngIf="!subcategoriesService.isLoading()">
      <ng-container matColumnDef="select" *ngIf="!isMobile">
        <th mat-header-cell *matHeaderCellDef>
          <mat-checkbox [checked]="isAllSelected()" (change)="toggleAllSubcategories($event.checked)" aria-label="Select all subcategories"></mat-checkbox>
        </th>
        <td mat-cell *matCellDef="let subcategory">
          <mat-checkbox [checked]="isSelected(subcategory)" (change)="toggleSubcategory(subcategory)" aria-label="Select subcategory"></mat-checkbox>
        </td>
      </ng-container>

      <ng-container matColumnDef="name">
        <th mat-header-cell *matHeaderCellDef>
          Name
          <button mat-icon-button [matMenuTriggerFor]="sortMenu" aria-label="Sort name">
            <mat-icon>sort</mat-icon>
          </button>
          <mat-menu #sortMenu="matMenu">
            <button mat-menu-item (click)="sortColumn('name', 'asc')" aria-label="Sort ascending">Ascending</button>
            <button mat-menu-item (click)="sortColumn('name', 'desc')" aria-label="Sort descending">Descending</button>
          </mat-menu>
        </th>
        <td mat-cell *matCellDef="let subcategory">{{ subcategory.name }}</td>
      </ng-container>

      <ng-container matColumnDef="icon">
        <th mat-header-cell *matHeaderCellDef>Icon</th>
        <td mat-cell *matCellDef="let subcategory">
          <mat-icon>{{ subcategory.icon }}</mat-icon>
        </td>
      </ng-container>

      <ng-container matColumnDef="imageUrl" *ngIf="!isMobile">
        <th mat-header-cell *matHeaderCellDef>Image</th>
        <td mat-cell *matCellDef="let subcategory">
          <img [src]="subcategory.imageUrl" alt="Subcategory Image" class="w-16 h-16 object-cover">
        </td>
      </ng-container>

      <ng-container matColumnDef="CategoryName" *ngIf="!isMobile">
        <th mat-header-cell *matHeaderCellDef>Category</th>
        <td mat-cell *matCellDef="let subcategory">{{ subcategory.CategoryName }}</td>
      </ng-container>

      <ng-container matColumnDef="createdAt" *ngIf="!isMobile && !isTablet">
        <th mat-header-cell *matHeaderCellDef>Created At</th>
        <td mat-cell *matCellDef="let subcategory">{{ subcategory.createdAt }}</td>
      </ng-container>

      <ng-container matColumnDef="modifiedAt" *ngIf="!isMobile && !isTablet">
        <th mat-header-cell *matHeaderCellDef>Modified At</th>
        <td mat-cell *matCellDef="let subcategory">{{ subcategory.modifiedAt }}</td>
      </ng-container>

      <ng-container matColumnDef="comments" *ngIf="!isMobile && !isTablet">
        <th mat-header-cell *matHeaderCellDef>Comments</th>
        <td mat-cell *matCellDef="let subcategory">{{ subcategory.comments }}</td>
      </ng-container>

      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef>Actions</th>
        <td mat-cell *matCellDef="let subcategory">
          <div *ngIf="!isMobile">
            <button mat-icon-button (click)="startEdit(subcategory)" aria-label="Edit subcategory">
              <mat-icon>edit</mat-icon>
            </button>
            <button mat-icon-button (click)="deleteSubcategory(subcategory.id)" aria-label="Delete subcategory">
              <mat-icon>delete</mat-icon>
            </button>
          </div>
          <button mat-icon-button *ngIf="isMobile" [matMenuTriggerFor]="menu" aria-label="Subcategory actions">
            <mat-icon>more_vert</mat-icon>
          </button>
          <mat-menu #menu="matMenu">
            <button mat-menu-item (click)="startEdit(subcategory)" aria-label="Edit subcategory">Edit</button>
            <button mat-menu-item (click)="deleteSubcategory(subcategory.id)" aria-label="Delete subcategory">Delete</button>
          </mat-menu>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns; let i = index" [attr.data-index]="trackById(i, row)"></tr>
    </table>

    <mat-paginator #paginator [pageSize]="subcategoriesService.pageSize()" [pageIndex]="subcategoriesService.currentPage() - 1" [length]="subcategoriesService.filteredSubcategories().length" (page)="onPageChange({ page: $event.pageIndex + 1 })" *ngIf="subcategoriesService.totalPages() > 0"></mat-paginator>

    <div class="pagination-controls" *ngIf="subcategoriesService.totalPages() > 0">
      <button mat-icon-button [disabled]="subcategoriesService.currentPage() === 1" (click)="onPageChange({ page: subcategoriesService.currentPage() - 1 })" aria-label="Previous page">
        <mat-icon>chevron_left</mat-icon>
      </button>
      <span *ngIf="!isMobile" class="page-numbers">
        <button mat-button *ngFor="let page of getPageNumbers()" [class.active]="page === subcategoriesService.currentPage()" (click)="onPageChange({ page: page })" [attr.aria-label]="'Page ' + page">
          {{ page }}
        </button>
      </span>
      <mat-form-field *ngIf="isMobile" appearance="outline" class="page-select">
        <mat-select [value]="subcategoriesService.currentPage()" (selectionChange)="onPageChange({ page: $event.value })" aria-label="Select page">
          <mat-option *ngFor="let page of getPageNumbers()" [value]="page">{{ page }}</mat-option>
        </mat-select>
      </mat-form-field>
      <button mat-icon-button [disabled]="subcategoriesService.currentPage() === subcategoriesService.totalPages()" (click)="onPageChange({ page: subcategoriesService.currentPage() + 1 })" aria-label="Next page">
        <mat-icon>chevron_right</mat-icon>
      </button>
    </div>
    <span class="no-pages text-sm" *ngIf="subcategoriesService.totalPages() === 0">No pages available</span>
  </div>
</div>